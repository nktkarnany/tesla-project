<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.sound.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>

    <style>
            *,
            *:before,
            *:after {
                margin: 0;
                padding: 0;
                border: 0;
            }
    
            html,
            body {
                display: block;
                max-width: 100vw;
                min-height: 100vh;
            }
    
            body {
                overflow: hidden;
            }
    </style>
</head>

<body>
    <script>
        /**
        * Motus: Synthwave
        * https://owenmcateer.github.io/Motus-Art
        */
        const mountainJSON = [
        {
            "type":"TRIANGLES",
            "close":"",
            "strokeColour":"#00fff8",
            "strokeWeight":0.5,
            "fill":"#002e44",
            "points":[
                {"x":0,"y":310},{"x":90,"y":230},{"x":30,"y":310},{"x":30,"y":310},{"x":120,"y":310},{"x":130,"y":220},
                {"x":90,"y":230},{"x":130,"y":220},{"x":30,"y":310},{"x":130,"y":220},{"x":170,"y":280},{"x":120,"y":310},
                {"x":190,"y":310},{"x":240,"y":250},{"x":220,"y":310},{"x":190,"y":310},{"x":200,"y":270},{"x":240,"y":250},
                {"x":200,"y":270},{"x":250,"y":210},{"x":240,"y":250},{"x":250,"y":210},{"x":210,"y":220},{"x":200,"y":270},
                {"x":170,"y":280},{"x":190,"y":230},{"x":180,"y":220},{"x":220,"y":310},{"x":280,"y":260},{"x":240,"y":310},
                {"x":240,"y":310},{"x":330,"y":310},{"x":300,"y":230},{"x":270,"y":270},{"x":270,"y":230},{"x":300,"y":230},
                {"x":300,"y":230},{"x":320,"y":190},{"x":270,"y":230},{"x":90,"y":230},{"x":90,"y":220},{"x":140,"y":190},
                {"x":90,"y":230},{"x":130,"y":220},{"x":140,"y":190},{"x":130,"y":220},{"x":150,"y":200},{"x":170,"y":280},
                {"x":170,"y":280},{"x":180,"y":220},{"x":150,"y":200},{"x":150,"y":200},{"x":140,"y":190},{"x":130,"y":220},
                {"x":430,"y":250},{"x":380,"y":280},{"x":390,"y":310},{"x":380,"y":280},{"x":370,"y":250},{"x":430,"y":250},
                {"x":430,"y":250},{"x":400,"y":230},{"x":370,"y":250},{"x":360,"y":230},{"x":380,"y":160},{"x":350,"y":160},
                {"x":350,"y":160},{"x":340,"y":190},{"x":360,"y":230},{"x":430,"y":250},{"x":530,"y":310},{"x":440,"y":310},
                {"x":530,"y":310},{"x":570,"y":270},{"x":610,"y":310},{"x":610,"y":310},{"x":540,"y":210},{"x":550,"y":250},
                {"x":570,"y":270},{"x":510,"y":200},{"x":530,"y":310},{"x":430,"y":250},{"x":490,"y":240},{"x":530,"y":310},
                {"x":510,"y":200},{"x":540,"y":210},{"x":550,"y":250},{"x":490,"y":240},{"x":470,"y":210},{"x":430,"y":250},
                {"x":430,"y":250},{"x":420,"y":150},{"x":470,"y":210},{"x":430,"y":250},{"x":400,"y":170},{"x":420,"y":150},
                {"x":420,"y":150},{"x":390,"y":120},{"x":400,"y":170},{"x":380,"y":160},{"x":370,"y":110},{"x":350,"y":160},
                {"x":350,"y":160},{"x":330,"y":110},{"x":340,"y":190},{"x":330,"y":110},{"x":350,"y":90},{"x":350,"y":160},
                {"x":350,"y":160},{"x":370,"y":110},{"x":350,"y":90},{"x":350,"y":90},{"x":330,"y":110},{"x":320,"y":50},
                {"x":320,"y":190},{"x":320,"y":130},{"x":280,"y":140},{"x":280,"y":140},{"x":280,"y":190},{"x":320,"y":190},
                {"x":280,"y":140},{"x":310,"y":100},{"x":320,"y":130},{"x":280,"y":140},{"x":280,"y":100},{"x":310,"y":100},
                {"x":310,"y":100},{"x":320,"y":50},{"x":280,"y":100},{"x":280,"y":100},{"x":280,"y":80},{"x":320,"y":50},
                {"x":420,"y":150},{"x":480,"y":160},{"x":510,"y":200},{"x":490,"y":240},{"x":510,"y":200},{"x":530,"y":310},
                {"x":400,"y":230},{"x":400,"y":170},{"x":380,"y":160},{"x":250,"y":210},{"x":260,"y":200},{"x":260,"y":240},
                {"x":210,"y":220},{"x":240,"y":180},{"x":250,"y":210},{"x":210,"y":220},{"x":200,"y":210},{"x":240,"y":180},
                {"x":240,"y":180},{"x":210,"y":170},{"x":200,"y":210},{"x":210,"y":170},{"x":240,"y":150},{"x":240,"y":180},
                {"x":210,"y":170},{"x":240,"y":120},{"x":240,"y":150},{"x":240,"y":150},{"x":270,"y":120},{"x":240,"y":120},
                {"x":240,"y":120},{"x":260,"y":90},{"x":270,"y":120},{"x":260,"y":90},{"x":280,"y":80},{"x":290,"y":50},
                {"x":260,"y":90},{"x":240,"y":90},{"x":290,"y":50},{"x":290,"y":50},{"x":240,"y":80},{"x":240,"y":90},
                {"x":290,"y":50},{"x":300,"y":30},{"x":320,"y":50},{"x":300,"y":30},{"x":310,"y":20},{"x":320,"y":50},
                {"x":320,"y":50},{"x":330,"y":30},{"x":310,"y":20},{"x":310,"y":20},{"x":290,"y":20},{"x":300,"y":30},
                {"x":290,"y":20},{"x":300,"y":0},{"x":310,"y":20},{"x":140,"y":190},{"x":160,"y":160},{"x":160,"y":190},
                {"x":150,"y":200},{"x":160,"y":190},{"x":140,"y":190},{"x":160,"y":190},{"x":180,"y":220},{"x":150,"y":200},
                {"x":210,"y":170},{"x":210,"y":130},{"x":260,"y":90},{"x":390,"y":120},{"x":480,"y":160},{"x":420,"y":150},
                {"x":480,"y":160},{"x":490,"y":160},{"x":510,"y":200},{"x":120,"y":310},{"x":170,"y":300},{"x":170,"y":280}
            ]
        },
        {
            "type":"TRIANGLES",
            "close":"",
            "strokeColour":"#00fff8",
            "strokeWeight":0.5,
            "fill":"#154675",
            "points":[
                {"x":120,"y":310},{"x":170,"y":300},{"x":190,"y":310},{"x":190,"y":310},{"x":200,"y":270},{"x":170,"y":300},
                {"x":170,"y":300},{"x":170,"y":280},{"x":200,"y":270},{"x":200,"y":270},{"x":190,"y":230},{"x":170,"y":280},
                {"x":190,"y":230},{"x":210,"y":220},{"x":200,"y":270},{"x":220,"y":310},{"x":270,"y":270},{"x":250,"y":210},
                {"x":270,"y":270},{"x":260,"y":240},{"x":270,"y":230},{"x":260,"y":240},{"x":320,"y":190},{"x":260,"y":190},
                {"x":250,"y":210},{"x":260,"y":200},{"x":260,"y":190},{"x":260,"y":190},{"x":250,"y":210},{"x":240,"y":180},
                {"x":240,"y":180},{"x":260,"y":190},{"x":280,"y":190},{"x":280,"y":190},{"x":280,"y":140},{"x":240,"y":180},
                {"x":240,"y":180},{"x":240,"y":150},{"x":280,"y":140},{"x":280,"y":140},{"x":240,"y":150},{"x":270,"y":120},
                {"x":270,"y":120},{"x":280,"y":140},{"x":280,"y":100},{"x":280,"y":100},{"x":270,"y":120},{"x":260,"y":90},
                {"x":260,"y":90},{"x":280,"y":80},{"x":280,"y":100},{"x":330,"y":310},{"x":350,"y":250},{"x":300,"y":230},
                {"x":350,"y":250},{"x":320,"y":190},{"x":300,"y":230},{"x":330,"y":310},{"x":360,"y":290},{"x":390,"y":310},
                {"x":390,"y":310},{"x":370,"y":250},{"x":360,"y":290},{"x":360,"y":290},{"x":330,"y":310},{"x":350,"y":250},
                {"x":350,"y":250},{"x":370,"y":250},{"x":360,"y":290},{"x":390,"y":310},{"x":440,"y":310},{"x":430,"y":250},
                {"x":490,"y":240},{"x":510,"y":200},{"x":470,"y":210},{"x":470,"y":210},{"x":510,"y":200},{"x":420,"y":150},
                {"x":430,"y":250},{"x":400,"y":170},{"x":400,"y":230},{"x":400,"y":230},{"x":360,"y":230},{"x":380,"y":160},
                {"x":360,"y":230},{"x":370,"y":250},{"x":400,"y":230},{"x":360,"y":230},{"x":350,"y":250},{"x":370,"y":250},
                {"x":360,"y":230},{"x":350,"y":250},{"x":320,"y":190},{"x":320,"y":190},{"x":340,"y":190},{"x":360,"y":230},
                {"x":320,"y":190},{"x":330,"y":110},{"x":340,"y":190},{"x":320,"y":190},{"x":320,"y":130},{"x":330,"y":110},
                {"x":330,"y":110},{"x":310,"y":100},{"x":320,"y":130},{"x":330,"y":110},{"x":320,"y":50},{"x":310,"y":100},
                {"x":380,"y":160},{"x":390,"y":120},{"x":400,"y":170},{"x":390,"y":120},{"x":370,"y":110},{"x":380,"y":160},
                {"x":480,"y":160},{"x":400,"y":100},{"x":390,"y":120},{"x":400,"y":100},{"x":370,"y":80},{"x":390,"y":120},
                {"x":370,"y":110},{"x":390,"y":120},{"x":370,"y":80},{"x":370,"y":80},{"x":350,"y":90},{"x":370,"y":110},
                {"x":320,"y":50},{"x":370,"y":80},{"x":350,"y":90},{"x":320,"y":50},{"x":370,"y":80},{"x":350,"y":60},
                {"x":350,"y":60},{"x":330,"y":30},{"x":320,"y":50},{"x":330,"y":30},{"x":310,"y":20},{"x":320,"y":0},
                {"x":320,"y":0},{"x":300,"y":0},{"x":310,"y":20},{"x":290,"y":50},{"x":320,"y":50},{"x":280,"y":80},
                {"x":290,"y":20},{"x":280,"y":40},{"x":300,"y":30},{"x":280,"y":40},{"x":290,"y":50},{"x":300,"y":30},
                {"x":280,"y":40},{"x":240,"y":80},{"x":290,"y":50},{"x":210,"y":130},{"x":220,"y":100},{"x":260,"y":90},
                {"x":260,"y":90},{"x":240,"y":90},{"x":220,"y":100},{"x":220,"y":100},{"x":240,"y":80},{"x":240,"y":90},
                {"x":220,"y":100},{"x":200,"y":110},{"x":190,"y":130},{"x":190,"y":130},{"x":210,"y":130},{"x":220,"y":100},
                {"x":190,"y":130},{"x":160,"y":160},{"x":160,"y":190},{"x":210,"y":220},{"x":180,"y":220},{"x":190,"y":230},
                {"x":200,"y":210},{"x":180,"y":220},{"x":210,"y":220},{"x":200,"y":210},{"x":180,"y":220},{"x":160,"y":190},
                {"x":160,"y":190},{"x":190,"y":180},{"x":200,"y":210},{"x":190,"y":180},{"x":210,"y":170},{"x":200,"y":210},
                {"x":190,"y":180},{"x":210,"y":170},{"x":210,"y":130},{"x":190,"y":130},{"x":190,"y":180},{"x":210,"y":130},
                {"x":190,"y":180},{"x":160,"y":190},{"x":190,"y":130}
            ]
        }
    ];

        // Variables to save audio data
        let audioContext;
        let analyser;
        let distortion;
        let gainNode;
        let buffer;
        let dataArray;
        let loaded = false;

        const canvas = 1080;
        const colours = [];

        let canvasBg;
        let canvasYlines;
        let canvasSun;
        let canvasMountain;
        let cx;
        let cy;
        let movement = 0;
        const horizon = 540;
        let mountainY = 440;

        let fft, // Allow us to analyze the song
        numBars = 1024, // The number of bars to use; power of 2 from 16 to 1024
        song; // The p5 sound object

        // generating mountains
        let yoff = 0.0;

        // Setup
        function setup() {
            createCanvas(windowWidth, windowHeight);
            //createCanvas(canvas, canvas);
            pixelDensity(1);

            cx = width / 2;
            cy = height / 2;
            colours[0] = color(164, 0, 182); // Pink
            colours[1] = color(0, 46, 68); // Night blue
            colours[2] = color(0, 255, 248); // Neon blue
            colours[3] = color(203, 0, 216); // Neon pink
            colours[4] = color(243, 255, 81); // Yellow
            colours[5] = color(249, 72, 106); // Orange

            // Draw background gradient
            canvasBg = drawBackground();

            // Draw vertical lines
            canvasYlines = drawYlines();

            // Draw sun
            canvasSun = drawSun();

            // Draw Mountain
            canvasMountain = drawMountain();
            
            fft = new p5.FFT();
            fft.waveform(numBars);
            fft.smooth(0.85);
        };

        // Draw tick
        function draw() {
            image(canvasBg, 0, 0);
            image(canvasSun, (width / 2) - (canvasSun.width / 2), 60);
            // image(canvasMountain, cx - (canvasMountain.width / 2), mountainY);

            noStroke();
            fill(colours[1]);
            rect(0, horizon, width, height);
            image(canvasYlines, 0, 0);

            for (let i = 0; i < 20; i++) {
                stroke(colours[0]);
                const yOffset = easeInExpo(i + (movement), 0, horizon, 20) + horizon;
                line(0, yOffset, width, yOffset);
            }

            // Speed around 98bpm
            movement += 0.0275;
            if (movement >= 1) {
                movement = 0;
            }

            mountainY -= 0.03;
            if (mountainY <= 333) {
                mountainY = 440;
            }

            if (typeof song != "undefined" && song.isPlaying()) {
                if(typeof fft != "undefined") {
                    var spectrum = fft.analyze();
                    console.log(spectrum);
                    noStroke();
                    fill(colours[0]);
                    for(var i = 0; i < numBars; i++) {
                        var x = map(i, 0, numBars, 0, width/1.3);
                        var h = -height + map(spectrum[i], 0, 255, height, 0);
                        rect(x, horizon, width / numBars, h/3);
                        rect(width-x, horizon, width / numBars, h/3);
                    }
                }
            }

            // if (loaded) {

            //     beginShape();
            //     let xoff = 0; // Option #1: 2D Noise
            //     // let xoff = yoff; // Option #2: 1D Noise

            //     // Iterate over horizontal pixels
            //     for (let x = 0; x <= width; x += 10) {
            //     // Calculate a y value according to noise, map to

            //     // Option #1: 2D Noise
            //     let y = map(noise(xoff, yoff), 0, 1, 200, 300);

            //     // console.log(xoff, yoff);

            //     // Option #2: 1D Noise
            //     // let y = map(noise(xoff), 0, 1, 200,300);

            //     // Set the vertex
            //     if (x < width/2)
            //         vertex(x, y + x/4);
            //     else
            //         vertex(x, y + (width - x - 10)/4);
            //     // Increment x dimension for noise
            //     xoff += 0.05;
            //     }
            //     // increment y dimension for noise
            //     yoff += 0.005;
            //     vertex(width, horizon);
            //     vertex(0, horizon);
            //     endShape(CLOSE);
            // }
        }

        function easeInExpo(t, b, c, d) {
            return (t == 0) ? b : c * Math.pow(2, 10 * (t / d - 1)) + b;
        }

        function drawBackground() {
            const sky = createGraphics(width, height);
            sky.background(colours[1]);

            // Draw gradient sky
            sky.noFill();
            for (let i = 0; i <= horizon; i++) {
                const inter = map(i, 0, horizon, 0, 1);
                const c = lerpColor(colours[0], colours[1], inter);
                sky.stroke(c);
                sky.line(0, i, width, i);
            }
            return sky;
        }

        // Draw vertical lines
        function drawYlines() {
            // Horizon
            const yLines = createGraphics(width, height);
            // Vertical lines
            yLines.stroke(colours[0]);
            yLines.line(0, horizon, width, horizon);
            yLines.line(cx, horizon, cx, height);
            for (let i = 1; i < 18; i++) {
                const xOffset = i * 30;
                yLines.line(cx + xOffset, horizon, cx + (xOffset * 10), height);
                yLines.line(cx - xOffset, horizon, cx - (xOffset * 10), height);
            }
            return yLines;
        }

        // Draw gradient sun
        function drawSun() {
            const sun = createGraphics(400, 400);
            sun.noFill();

            for (let i = 0; i <= sun.height; i++) {
                // Draw or skip?
                if ((i > 250 && i < 255)
                    || (i > 292 && i < 300)
                    || (i > 332 && i < 342)
                    || (i > 373 && i < 387)
                    || (i > 412 && i < 430)
                    || (i > 452 && i < 475)
                ) {
                    continue;
                }
                else {

                    // Calc colour
                    const inter = map(i, 0, sun.height, 0, 1);
                    const c = lerpColor(colours[4], colours[5], inter);
                    sun.stroke(c);

                    // Calc circle
                    const s = i * 2;
                    const r = sun.width;
                    const lineWidth = Math.sqrt((2 * s * r) - Math.pow(s, 2));
                    const offset = (sun.width / 2) - (lineWidth / 2);
                    sun.line(offset, i, lineWidth + offset, i);
                }
            }
            return sun;
        }

        // Draw Mountain
        function drawMountain() {
            const mountain = createGraphics(610, 310);

            // Draw shapes.
            for (let i = 0; i < mountainJSON.length; i++) {
                const s = mountainJSON[i];

                mountain.stroke(color(s.strokeColour));
                mountain.strokeWeight(s.strokeWeight);
                if (s.fill) {
                    mountain.fill(color(s.fill));
                }
                else {
                    mountain.noFill();
                }
                mountain.beginShape(shapeTypeValue(s.type));

                for (let p = 0; p < s.points.length; p++) {
                    mountain.vertex(s.points[p].x, s.points[p].y);
                }
                mountain.endShape(shapeTypeValue(s.close));
            }
            return mountain;
        }

        // Converts JSON shape naming into P5 constants
        function shapeTypeValue(type) {
            const shapeTypes = {
                'POINTS': POINTS,
                'LINES': LINES,
                'TRIANGLES': TRIANGLES,
                'TRIANGLE_STRIP': TRIANGLE_STRIP,
                'TRIANGLE_FAN': TRIANGLE_FAN,
                'QUADS': QUADS,
                'QUAD_STRI': QUAD_STRIP,
                '': '',
            };
            return shapeTypes[type];
        }

        function changeAudioParticles(dataArray) {
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += parseInt(dataArray[i], 10); //don't forget to add the base
            }

            let avg = sum / dataArray.length;

            // if (avg > 100) {
            //     // TweenMax.to(groundPlain, 0.5, { scale: 80, ease: Power3.easeOut });
            // } else if (avg > 80) {
            //     // TweenMax.to(groundPlain, 0.5, { scale: 60, ease: Power3.easeOut });
            // } else {
            //     // TweenMax.to(groundPlain, 0.5, { scale: 30, ease: Power3.easeOut });
            // }

        }

        // Event listener added to listen onclick and load a song
        window.addEventListener("click", onClick);

        function onClick() {
            song.play();
        }

        function preload() {
            song = loadSound("./toto.mp3");
        }

    </script>
</body>

</html>